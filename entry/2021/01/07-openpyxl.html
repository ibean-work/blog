<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>openpyxlでExcelを操る！</title>
  <link rel="stylesheet" href="../../../style.css">
  <link rel="stylesheet" href="../../../code-highlight-style.css">
  <link rel="icon" href="../../../favicon.ico">
</head>

<body>
<header>
  <div class="header-container">
    <h1><a href="../../../index.html">iBean</a></h1>
    <div class="aboutme"><a href="./01-aboutme.html">About me</a></div>
  </dif>
</header>

<main>
  <div class="card">
    <h1>openpyxlでExcelを操る！</h1>
    <h5>
      <time datetime="2021-01-07">2021-01-07</time>
    </h5>
    <div class="kijicat">
      <ul>
        <li>プログラミング</li>
      </ul>
    </div>
    <section>
      <h2>Excel操作が大変なのでどうにかしたい</h2>
      <p>
        今どきは、Excelを操作するライブラリが充実しているので、簡単な作業であればネットに書かれているサンプルをコピーして少し書き換えるだけで、すぐに作業を自動化できます。
        今回はプログラミング言語pythonを使ってExcel操作の方法を説明して行きます。なお、python自体のインストールや環境構築は既に終わているものとして説明を進めます。
      </p>
      <h3>openpyxlのインストール</h3>
      <p>
        pythonを使ってExcelの読み書きを行うためにopenpyxlというライブラリをインストールしましょう。以下のコマンドで簡単にインストールできます。
      </p>
      <div class="code-frame">
        > pip install openpyxl
      </div>
      <h3>openpyxlの使い方</h3>
      <P>説明のため次のような内容のExcelファイル(book.xlsx)を用意しました。このファイルを読み込んで、いろいろな操作を行ってみましょう。</P>
      <img class="fit-img" src="../../../img/2021/01/excel01.png" alt="excel-file">
      <p>まずは、Excelを開いてA1セルの値（今回のExcelでは「太郎」）を出力してみます。</p>
      <div class="code-frame">
        <div class="highlight"><pre><span></span><span class="n">import</span> <span class="n">openpyxl</span>

<span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="s2">&quot;book.xlsx&quot;</span><span class="p">)</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">[</span><span class="s2">&quot;Sheet1&quot;</span><span class="o">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ws</span><span class="o">[</span><span class="s2">&quot;A1&quot;</span><span class="o">].</span><span class="n">value</span><span class="p">)</span> <span class="c1"># ws.cell(1, 1)でも同じ</span></pre>
        </div>
      </div>
      <p>１行目に項目名を入れた方が分かりやすいので、項目名を追加して新しくbook2.xlsxとしてファイルを保存してみます。シートに行を追加するには、関数 insert_rows() を使います。</p>
      <div class="code-frame">
        <div class="highlight"><pre><span></span><span class="n">import</span> <span class="n">openpyxl</span>

<span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="s2">&quot;book.xlsx&quot;</span><span class="p">)</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">[</span><span class="s2">&quot;Sheet1&quot;</span><span class="o">]</span>
<span class="n">ws</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># １行目の上に行を追加</span>
<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;名前&quot;</span>
<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;職業&quot;</span>
<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;年齢&quot;</span>
<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;所持金&quot;</span>

<span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;book2.xlsx&quot;</span><span class="p">)</span></pre>
        </div>
      </div>
      <p>このスクリプトを実行すると、Excelファイルは次のようになります。</p>
      <img class="fit-img" src="../../../img/2021/01/excel02.png" alt="excel-file">
      <h3>簡単な分析をやってみる</h3>
      <p>それでは次に、book.xslxのデータを基に簡単な分析をしてみましょう。職業別の所持金の平均値を求めてみます。<p>
        プログラムの流れは次の通りです。
        <ol>
          <li>Excelから１行ずつデータを読込み、職業をキー、所持金のリストを値にした辞書を作成する<br>（例： { "小学生": [2000, 500], "中学生": [20000] }  ）。</li>
          <li>1.で作成した配列を sum() で足し合わせ、得られた合計を要素の数 len() で割る。</li>
        </ol>
      <div class="code-frame">
        <div class="highlight"><pre><span></span><span class="n">import</span> <span class="n">openpyxl</span>

<span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="s2">&quot;book.xlsx&quot;</span><span class="p">)</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">[</span><span class="s2">&quot;Sheet1&quot;</span><span class="o">]</span>

<span class="c1"># ワークシートのデータが存在する最終行を取得する</span>
<span class="n">bottom_row</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">max_row</span>

<span class="n">money_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bottom_row</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">in</span> <span class="ss">money_data</span><span class="p">:</span>
        <span class="n">money_data</span><span class="o">[</span><span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">].</span><span class="n">append</span><span class="p">(</span><span class="n">int</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">money_data</span><span class="o">[</span><span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">int</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">]</span>

<span class="k">for</span> <span class="n">data</span> <span class="k">in</span> <span class="n">money_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;{} - {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span><span class="o">/</span><span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)))</span>
          </pre></div>
      </div>
      <p>
        このプログラムの実行結果：
        <div class="code-frame">
          小学生 - 1250.0<br>
          中学生 - 20000.0<br>
          高校生 - 50000.0<br>
          大学生 - 138750.0<br>
          公務員 - 1000000.0<br>
        </div>
      </p>
      <p>
        正しく職業別の平均値が得られています。このプログラムであれば、職業の種類が増えてもデータの数が増えても正しく平均値を集計してくれます。
      </p>
      <p>
        今回紹介した程度の計算であれば、Excelのピボットテーブルを使えばすぐに求めることができます。しかし、同じフォーマットのExcelが100個あって、その中にある全ての数値の平均値を求めたいという状況であれば、プログラムを作成した方が良いでしょう。
        Excel自体の機能でもできることは結構あるので、そこら辺の機能を見極めながらプログラミングによるシステム化を検討してみてください。
      </p>
      <h2>まとめ</h2>
      <p>
        単純な操作を大量に行うのであれば、プログラミングを行って自動化の検討をしてみるべきです。単純なプログラムでも組み合わせれば、それなりに複雑なこともできるので仕事で楽したいと思っている人はぜひプログラミングを学んでみてください。<br>
      </p>
      <dvi class="amazon-box">
        <div class="amazon-container">
          <a href="https://amzn.to/2Kpot36" target="_blank"><img src="https://m.media-amazon.com/images/I/51+xv65qdBL._SL160_.jpg"/></a>
        </div>
        <dvi class ="amazon-content">
          <ul>
            <li><a href="https://amzn.to/2Kpot36" target="_blank">入門 Python 3</a></li>
            <li>Bill Lubanovic (著), 斎藤 康毅  (監修), 長尾 高弘  (翻訳)</li>
            <li>出版社 : オライリージャパン</li>
            <li>発売日 : 2015/12/1</li>
          </ul>
        </dvi>
      </dvi>
    </section>
  </div>
</main>

<footer>
  <div class="footer-container">
    <div class="next"><a href="./10-reclass-table.html">&lt;&lt; Excelで組替表を作る</a></div>
    <div class="prev"><a href="./02-accounting-person.html">経理の仕事をしている人を英語で何と呼ぶ？ &gt;&gt;</a></div>
    <div class="top"><a href="../../../index.html">トップへ戻る</a></div>
    <div class="copyright">
      <small>Copyright(C)iBean, Allright Reserved.</small>
    </div>
  </div>
</footer>
</body>
</html>